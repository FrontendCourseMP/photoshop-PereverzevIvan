import{j as t,u as N,r as d,i as H,M as T,a as M}from"./index-Cn7OMWZh.js";const p=256,I=({histogram:g,channel:u,controlPoints:o,onChange:s})=>{const h=Math.max(...g),a=()=>{switch(u){case"r":return"red";case"g":return"green";case"b":return"blue";case"l":return"gray";case"a":return"black"}},f=g.map((i,y)=>{const n=i/h,c=p-n*p;return`${y},${c}`}).join(" "),[e,x]=o,b=(i,y,n)=>{const c=Math.max(0,Math.min(255,n)),l=[...o],r={...l[i],[y]:c};y==="input"&&(i===0&&r.input>l[1].input-1||i===1&&r.input<l[0].input+1)||(l[i]=r,s(l))};return t.jsxs("div",{style:{display:"flex",flexDirection:"column",width:p},children:[t.jsxs("svg",{width:p,height:p,style:{border:"1px solid #ccc"},children:[t.jsx("line",{x1:0,y1:p,x2:p,y2:0,stroke:"blue",strokeWidth:1}),t.jsx("polyline",{fill:"none",stroke:a(),strokeWidth:"1",points:f}),t.jsx("line",{x1:e.input,y1:p-e.output,x2:x.input,y2:p-x.output,stroke:"black",strokeWidth:1}),t.jsx("line",{x1:0,x2:e.input,y1:p-e.output,y2:p-e.output,stroke:"black"}),t.jsx("line",{x1:x.input,x2:p,y1:p-x.output,y2:p-x.output,stroke:"black"}),t.jsx("circle",{cx:e.input,cy:p-e.output,r:4,fill:"white",stroke:"black"}),t.jsx("circle",{cx:x.input,cy:p-x.output,r:4,fill:"black",stroke:"black"})]}),t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"8px",gap:"8px"},children:[t.jsxs("div",{style:{display:"flex",flexDirection:"column",width:"100%",gap:"4px"},children:[t.jsx("label",{children:"Точка 1:"}),t.jsx("br",{}),"In:"," ",t.jsx("input",{type:"number",min:0,max:255,value:e.input,onChange:i=>b(0,"input",+i.target.value)}),"Out:"," ",t.jsx("input",{type:"number",min:0,max:255,value:e.output,onChange:i=>b(0,"output",+i.target.value)})]}),t.jsxs("div",{style:{display:"flex",flexDirection:"column",width:"100%",gap:"4px"},children:[t.jsx("label",{children:"Точка 2:"}),t.jsx("br",{}),"In:"," ",t.jsx("input",{type:"number",min:0,max:255,value:x.input,onChange:i=>b(1,"input",+i.target.value)}),"Out:"," ",t.jsx("input",{type:"number",min:0,max:255,value:x.output,onChange:i=>b(1,"output",+i.target.value)})]})]})]})};function W(g){const{data:u}=g,o=new Array(256).fill(0),s=new Array(256).fill(0),h=new Array(256).fill(0);for(let a=0;a<u.length;a+=4)o[u[a]]++,s[u[a+1]]++,h[u[a+2]]++;return{r:o,g:s,b:h}}function V(g){const u=new Array(256).fill(0),o=g.data;for(let s=0;s<o.length;s+=4){const h=Math.round((o[s]+o[s+1]+o[s+2])/3);u[h]++}return u}function $(g){const u=new Array(256).fill(0),o=g.data,s=o.length;for(let h=3;h<s;h+=4){const a=o[h];u[a]++}return u}function D(g,u){const{data:o,width:s,height:h}=g,a=new ImageData(s,h),f=([n,c])=>{const l=new Uint8ClampedArray(256);for(let r=0;r<256;r++)if(r<=n.input)l[r]=n.output;else if(r>=c.input)l[r]=c.output;else{const v=(r-n.input)/(c.input-n.input);l[r]=Math.round(n.output+v*(c.output-n.output))}return l},e=u.r?f(u.r):null,x=u.g?f(u.g):null,b=u.b?f(u.b):null,i=u.gray?f(u.gray):null,y=u.alpha?f(u.alpha):null;for(let n=0;n<o.length;n+=4){const c=o[n],l=o[n+1],r=o[n+2],v=o[n+3];if(i){const C=Math.round(.299*c+.587*l+.114*r),j=i[C];a.data[n]=j,a.data[n+1]=j,a.data[n+2]=j}else a.data[n]=e?e[c]:c,a.data[n+1]=x?x[l]:l,a.data[n+2]=b?b[r]:r;a.data[n+3]=y?y[v]:v}return a}const F="_container_6wgb4_1",Y="_buttonBox_6wgb4_9",Z="_previewImage_6wgb4_16",q="_curvesContainer_6wgb4_24",_={container:F,buttonBox:Y,previewImage:Z,curvesContainer:q};function J(g){const u="Градационная коррекция",{layers:o,activeLayerId:s,setOriginalImageData:h}=N(),[a,f]=d.useState(null),[e,x]=d.useState(null),[b,i]=d.useState(null),[y,n]=d.useState([{input:0,output:0},{input:255,output:255}]),[c,l]=d.useState([{input:0,output:0},{input:255,output:255}]),[r,v]=d.useState([{input:0,output:0},{input:255,output:255}]),[C,j]=d.useState([{input:0,output:0},{input:255,output:255}]),[k,A]=d.useState([{input:0,output:0},{input:255,output:255}]),[P,B]=d.useState(null),w=d.useMemo(()=>{if(!e)return null;const m=$(e),S=V(e),{r:L,g:O,b:U}=W(e);return B(!H(e)),{alpha:m,gray:S,r:L,g:O,b:U}},[e]);function R(){if(e)if(P){const m=D(e,{r:y,g:c,b:r,alpha:k});i(M(m))}else{const m=D(e,{gray:C,alpha:k});i(M(m))}}function E(){if(e&&s!==null){if(P){const m=D(e,{r:y,g:c,b:r,alpha:k});h(s,m)}else{const m=D(e,{gray:C,alpha:k});h(s,m)}g.onClose()}}function G(){n([{input:0,output:0},{input:255,output:255}]),l([{input:0,output:0},{input:255,output:255}]),v([{input:0,output:0},{input:255,output:255}]),j([{input:0,output:0},{input:255,output:255}]),A([{input:0,output:0},{input:255,output:255}]),i(null)}return d.useEffect(()=>{if(s!==null){const m=o.find(S=>S.id===s);f(m||null)}else f(null)},[s,o]),d.useEffect(()=>{x(a?a.originalImageData:null)},[a]),d.useEffect(()=>{g.isOpen&&G()},[g.isOpen]),t.jsx(T,{...g,title:u,children:e&&w?t.jsxs("div",{className:_.container,children:[t.jsxs("div",{className:_.curvesContainer,children:[P?t.jsxs(t.Fragment,{children:[t.jsx(I,{histogram:w.r,channel:"r",controlPoints:y,onChange:n}),t.jsx(I,{histogram:w.g,channel:"g",controlPoints:c,onChange:l}),t.jsx(I,{histogram:w.b,channel:"b",controlPoints:r,onChange:v})]}):t.jsx(I,{histogram:w.gray,channel:"l",controlPoints:C,onChange:j}),t.jsx(I,{histogram:w.alpha,channel:"a",controlPoints:k,onChange:A})]}),t.jsxs("div",{className:_.buttonBox,children:[t.jsx("button",{onClick:()=>G(),children:"Сброс"}),t.jsx("button",{onClick:()=>R(),children:"Предпросмотр"}),t.jsx("button",{onClick:()=>E(),children:"Применить"})]}),b&&t.jsx("img",{src:b,alt:"Preview",className:_.previewImage})]}):t.jsx("p",{children:"Изображение не загружено"})})}export{J as CorrectionModal};
